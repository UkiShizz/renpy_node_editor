# RenPy Node Editor

Десктопный редактор для создания Ren'Py скриптов через визуальный граф узлов. Вместо ручного написания кода — просто расставляйте блоки (диалоги, меню, переходы) и соединяйте их линиями.

## Основные возможности

- **Визуальный редактор сцен**: создавайте логику игры как граф с узлами (блоками) и соединениями
- **Разнообразные типы блоков**: SAY, MENU, IF, JUMP, CALL, SCENE, SHOW, MUSIC, SOUND и многие другие
- **Редактор параметров**: интерактивное редактирование параметров блоков прямо в интерфейсе
- **Генерация кода**: автоматическое преобразование графа в готовый script.rpy
- **Запуск в Ren'Py**: сразу запустите созданный проект через Ren'Py SDK
- **Сохранение проектов**: экспортируйте и импортируйте проекты в формате JSON
- **Множественные сцены**: создавайте несколько сцен (актов) в одном проекте

## Структура проекта

```
renpy_node_editor/
├── src/
│   └── renpy_node_editor/
│       ├── core/           # Модели данных (Block, Scene, Project)
│       ├── runner/         # Интеграция с Ren'Py SDK
│       └── ui/             # Графический интерфейс
│           ├── node_graph/ # Визуальное представление графа
│           └── block_*.py  # Палитра и редактор блоков
├── configs/                # Конфигурация типов блоков
└── tests/                  # Тесты
```

## Быстрый старт

### Требования

- Python 3.8+
- PySide6
- Ren'Py SDK (для запуска созданных проектов)

### Установка

```bash
# Клонируйте репозиторий
git clone https://github.com/UkiShizz/renpy_node_editor.git
cd renpy_node_editor

# Создайте виртуальное окружение
python -m venv .venv

# Активируйте окружение
# Windows:
.\venv\Scripts\activate
# Linux/macOS:
source venv/bin/activate

# Установите зависимости
pip install -r requirements.txt
```

### Запуск

```bash
python -m renpy_node_editor.ui.main_window
```

## Настройка Ren'Py SDK

Редактор не включает сам Ren'Py, поэтому вам нужно установить SDK отдельно.

1. Скачайте [Ren'Py SDK](https://www.renpy.org/) и распакуйте в удобное место
2. По умолчанию редактор ищет SDK здесь:
   - **Windows**: `C:\RenPy\renpy-8.3.7`
   - **Linux**: `/opt/renpy/renpy-8.3.7`

3. Если у вас другой путь, измените переменную `default_sdk_root()` в `runner/renpy_env.py`

## Руководство по использованию

### Шаг 1: Создание проекта в Ren'Py

**ВАЖНО**: Перед экспортом кода в Ren'Py проект, вы должны сначала создать новый проект через Ren'Py SDK.

1. Запустите Ren'Py SDK (Launcher)
2. Нажмите "Create New Project"
3. Введите название проекта и выберите папку для сохранения
4. Дождитесь создания проекта
5. **Запомните путь к папке проекта** — он понадобится для экспорта

### Шаг 2: Создание проекта в редакторе

1. Запустите RenPy Node Editor
2. Нажмите кнопку **"Новый проект"** в верхней панели
3. Введите название проекта
4. Выберите папку, где будет сохранен файл проекта редактора (это отдельно от проекта Ren'Py)
5. Нажмите "Сохранить"

После создания проекта вы увидите:
- **Левая панель**: пустой канвас для работы со сценами
- **Правая панель**: палитра блоков, управление сценами и редактор свойств

### Шаг 3: Работа со сценами

Проект может содержать несколько сцен (актов). Каждая сцена — это отдельный граф блоков.

#### Создание новой сцены

1. В правой панели найдите секцию **"Управление сценами"**
2. Нажмите кнопку **"Добавить сцену"**
3. Введите название сцены (например, "Акт 1", "Пролог")
4. Новая сцена появится в списке и станет активной

#### Переключение между сценами

- Кликните на название сцены в списке сцен
- Активная сцена отображается на канвасе

#### Удаление сцены

- Выберите сцену в списке
- Нажмите кнопку **"Удалить сцену"**

### Шаг 4: Добавление блоков

1. В правой панели найдите **палитру блоков**
2. Блоки сгруппированы по категориям:
   - **Flow**: START, LABEL, JUMP, CALL, RETURN
   - **Dialogue**: SAY, NARRATION
   - **Visual**: SCENE, SHOW, HIDE
   - **Logic**: IF, MENU, WHILE, FOR
   - **Audio**: MUSIC, SOUND, STOP_MUSIC
   - **Variables**: SET_VAR, DEFAULT
   - И другие...

3. **Перетащите** нужный блок из палитры на канвас
4. Блок появится на канвасе в месте, где вы его отпустили

### Шаг 5: Редактирование блоков

1. **Кликните** на блок на канвасе
2. В правой панели откроется **редактор свойств** (Properties Panel)
3. Заполните параметры блока:
   - Для **SAY**: выберите персонажа и введите текст
   - Для **SCENE**: выберите фоновое изображение
   - Для **JUMP/CALL**: выберите метку из выпадающего списка
   - И так далее...
4. Нажмите кнопку **"Save Properties"** для сохранения изменений

#### Особенности редактирования:

- **JUMP и CALL блоки**: имеют выпадающий список со всеми метками из всех сцен проекта
- **SAY блоки**: автоматически определяют персонажей из проекта
- **Изображения и аудио**: можно выбрать файлы через диалог выбора файла

### Шаг 6: Соединение блоков

Блоки соединяются линиями для создания потока выполнения.

1. **Наведите курсор** на выходной порт блока (правая сторона блока)
2. **Зажмите левую кнопку мыши** и перетащите
3. **Отпустите** на входном порту другого блока (левая сторона)
4. Соединение появится в виде линии

#### Правила соединения:

- Блоки выполняются **сверху вниз** в порядке соединений
- Для **последовательной цепочки**: один выход → один вход
- Для **параллельных веток**: один выход → несколько входов (например, для IF блока)
- Для **точек слияния**: несколько выходов → один вход

#### Удаление соединения:

- **Кликните** на соединение (линию)
- Нажмите клавишу **Delete** или **Backspace**

### Шаг 7: START блоки и метки

**START блок** — это точка входа в сцену. Каждая сцена должна иметь хотя бы один START блок.

1. Добавьте блок **START** на канвас
2. В редакторе свойств введите **имя метки (label)** (например, "first", "second", "start")
3. Сохраните свойства
4. Соедините START блок с другими блоками

**Важно:**
- START блоки генерируют `label` в Ren'Py коде
- Метки из START блоков доступны для JUMP и CALL блоков
- В начале скрипта автоматически создается `label start:`, который переходит к первому START блоку

### Шаг 8: Сохранение проекта

Проект редактора сохраняется автоматически при работе, но вы можете сохранить его вручную:

1. Нажмите кнопку **"Сохранить проект"** в верхней панели
2. Или используйте горячую клавишу **Ctrl+S**

Проект сохраняется в формате JSON в папке, которую вы выбрали при создании проекта.

### Шаг 9: Просмотр сгенерированного кода

1. Нажмите кнопку **"Сгенерировать код"** в верхней панели
2. Откроется панель предпросмотра с сгенерированным Ren'Py кодом
3. Вы можете скопировать код или просмотреть его перед экспортом

### Шаг 10: Экспорт в проект Ren'Py

**ВАЖНО**: Убедитесь, что вы уже создали проект Ren'Py через Ren'Py SDK (см. Шаг 1).

1. Нажмите кнопку **"Экспорт в Ren'Py проект"** в верхней панели
2. В диалоге выберите **папку проекта Ren'Py** (не папку `game`, а корневую папку проекта)
   - Например: `C:\Users\YourName\Documents\RenPy\MyGame\`
   - Не выбирайте: `C:\Users\YourName\Documents\RenPy\MyGame\game\`
3. Нажмите "Выбрать папку"
4. Редактор:
   - Создаст или обновит файл `script.rpy` в папке `game/`
   - Скопирует изображения и аудио файлы в соответствующие папки
   - Преобразует абсолютные пути в относительные

**Если проект Ren'Py не существует:**
- Редактор создаст базовую структуру проекта
- Но рекомендуется сначала создать проект через Ren'Py SDK для правильной настройки

### Шаг 11: Запуск в Ren'Py

1. После экспорта нажмите кнопку **"Запустить в Ren'Py"**
2. Если Ren'Py SDK настроен правильно, проект откроется в Ren'Py Launcher
3. Нажмите "Launch Project" для запуска игры

## Типы блоков

### Структура сценария

| Блок | Описание | Параметры |
|------|---------|----------|
| **START** | Точка входа в сцену, генерирует метку (label) | `label` - имя метки |
| **LABEL** | Создает метку для переходов | `label` - имя метки |
| **RETURN** | Возврат из функции/сцены | - |

### Диалоги и текст

| Блок | Описание | Параметры |
|------|---------|----------|
| **SAY** | Диалог персонажа | `character` - персонаж, `text` - текст |
| **NARRATION** | Повествование (текст без персонажа) | `text` - текст |

### Визуальные элементы

| Блок | Описание | Параметры |
|------|---------|----------|
| **SCENE** | Смена фона | `background` - изображение фона, `layer`, `transition` |
| **SHOW** | Показать персонажа/изображение | `image` - изображение, `at`, `with` |
| **HIDE** | Скрыть персонажа/изображение | `image` - изображение, `with` |
| **IMAGE** | Определение изображения | `name` - имя, `file` - путь к файлу |

### Логика игры

| Блок | Описание | Параметры |
|------|---------|----------|
| **MENU** | Меню выбора для игрока | `prompt` - текст вопроса, `options` - варианты ответов |
| **IF** | Условное ветвление | `condition` - условие |
| **WHILE** | Цикл while | `condition` - условие |
| **FOR** | Цикл for | `variable` - переменная, `iterable` - итерируемый объект |
| **JUMP** | Переход на другую метку | `label` - имя метки (выпадающий список) |
| **CALL** | Вызов другой сцены | `label` - имя метки (выпадающий список) |

### Эффекты и паузы

| Блок | Описание | Параметры |
|------|---------|----------|
| **PAUSE** | Пауза в сценарии | `duration` - длительность в секундах |
| **TRANSITION** | Переход между сценами | `transition` - тип перехода, `duration` |
| **WITH** | Применить переход | `transition` - тип перехода |

### Аудио

| Блок | Описание | Параметры |
|------|---------|----------|
| **MUSIC** | Фоновая музыка | `music_file` - путь к файлу, `loop` - зацикливание |
| **SOUND** | Звуковые эффекты | `sound_file` - путь к файлу |
| **STOP_MUSIC** | Остановить музыку | `fadeout` - время затухания |
| **STOP_SOUND** | Остановить звук | - |
| **VOICE** | Голосовая реплика | `voice_file` - путь к файлу |

### Переменные и данные

| Блок | Описание | Параметры |
|------|---------|----------|
| **SET_VAR** | Установить переменную | `variable` - имя переменной, `value` - значение |
| **DEFAULT** | Значение по умолчанию | `variable` - имя переменной, `value` - значение |
| **DEFINE** | Определение константы | `name` - имя, `value` - значение |
| **PYTHON** | Выполнить Python код | `code` - код Python |

### Персонажи и определения

| Блок | Описание | Параметры |
|------|---------|----------|
| **CHARACTER** | Определение персонажа | `name` - имя, `display_name` - отображаемое имя, `color` - цвет |
| **STYLE** | Определение стиля | `name` - имя стиля, параметры стиля |

### Дополнительные функции

| Блок | Описание | Параметры |
|------|---------|----------|
| **TEXT** | Текст на экране | `text` - текст, `x`, `y` - позиция |
| **CENTER** | Центрированный текст | `text` - текст |

## Советы и рекомендации

### Организация проекта

- Используйте **несколько сцен** для разных актов или глав игры
- Каждая сцена должна иметь **хотя бы один START блок** с уникальной меткой
- Используйте **осмысленные имена** для меток (например, "prologue", "chapter1", "ending")

### Работа с изображениями

- Добавьте изображения через блок **IMAGE** перед их использованием
- Используйте блок **CHARACTER** для определения персонажей
- Пути к файлам автоматически преобразуются в относительные при экспорте

### Работа с метками и переходами

- **JUMP** — безусловный переход (не возвращается)
- **CALL** — вызов сцены (возвращается через RETURN)
- Метки из всех сцен доступны в выпадающем списке JUMP/CALL блоков

### Отладка

- Используйте кнопку **"Сгенерировать код"** для проверки сгенерированного кода перед экспортом
- Проверяйте консоль на наличие ошибок при генерации
- Убедитесь, что все пути к файлам корректны

## Разработка

### Запуск тестов

```bash
python -m pytest tests/
```

### Добавление новых типов блоков

1. Отредактируйте `configs/blocks_schema.json` — добавьте новый тип
2. Обновите `BlockType` в `core/model.py`
3. Добавьте генератор кода в `core/generator/blocks.py`
4. Добавьте UI логику в `ui/block_properties_panel.py`

## Архитектура

- **Model** (`core/model.py`): структуры данных для проекта, сцены, блоков
- **Controller** (`app_controller.py`): бизнес-логика для работы с проектами
- **View** (`ui/`): все UI компоненты на PySide6
- **Runner** (`runner/`): интеграция с Ren'Py для генерации и запуска
- **Generator** (`core/generator/`): генерация Ren'Py кода из модели

## Лицензия

MIT

## Связь

Если нашли баги или есть идеи — создавайте issues на GitHub.
